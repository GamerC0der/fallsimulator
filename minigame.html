<!DOCTYPE html>
<html>
<head>
    <title>Pumpkin Spawner</title>
    <style>
        body {
            background-color: lightblue;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }

        .pumpkin {
            position: absolute;
            width: 120px;
            height: 240px;
            cursor: pointer;
            transition: opacity 0.3s ease;
        }

        .pumpkin:hover {
            opacity: 0.7;
        }

        .counter {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 165, 0, 0.9);
            color: #f0f0f0;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 16px;
            font-weight: bold;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .back-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            background: none;
            color: #f0f0f0;
            padding: 10px 15px;
            border-radius: 50%;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            z-index: 1000;
            border: none;
            transition: opacity 0.3s ease;
        }

        .back-btn:hover {
            opacity: 0.7;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .modal-content {
            background-color: #2d2d3d;
            color: #f0f0f0;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        .modal-content h2 {
            margin-top: 0;
            color: #ffa500;
            font-size: 24px;
        }

        .modal-content p {
            font-size: 18px;
            margin: 15px 0;
        }

        .modal-content .score {
            font-size: 48px;
            font-weight: bold;
            color: #ffa500;
            text-shadow: 0 0 10px rgba(255, 165, 0, 0.5);
        }

        .close-btn {
            background-color: #4CAF50;
            color: #f0f0f0;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 20px;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }

        .close-btn:hover {
            background-color: #45a049;
        }
    </style>
<body>
    <header>
        <button id="back-btn" class="back-btn" aria-label="Back to main game">‚Üê</button>
        <div id="counter" class="counter" aria-label="Pumpkin click counter">üéÉ 0</div>
    </header>

    <main id="game-area" aria-label="Pumpkin clicking game area">
        <!-- Pumpkins will be dynamically added here -->
    </main>

    <div id="game-modal" class="modal" role="dialog" aria-labelledby="modal-title" aria-hidden="true">
        <div class="modal-content">
            <h2 id="modal-title">üéÉ Time's Up!</h2>
            <p>You clicked</p>
            <div class="score" id="final-score" aria-label="Final pumpkin count">0</div>
            <p>pumpkins!</p>
            <p>You earned <span class="score" id="gems-earned" aria-label="Gems earned">0</span> gems! üèÜ</p>
            <button id="close-modal" class="close-btn">Back</button>
        </div>
    </div>

    <script>
        const GAME_CONFIG = {
            PUMPKIN: {
                IMAGE: 'pumpkin.png',
                MIN_SIZE: 40,
                MAX_SIZE: 80,
                FADE_DURATION: 300,
                LIFETIME: 10000,
                SPAWN_INTERVAL: 800,
                INITIAL_COUNT: 5,
                SPAWN_DELAY: 200,
                MAX_COUNT: 15
            },
            UI: {
                COUNTER_EMOJI: 'üéÉ',
                GAME_DURATION: 15000,
                GEMS_PER_CLICK: 10
            },
            STORAGE: {
                GEMS_KEY: 'minigameGems',
                PARENT_GEMS_KEY: 'gems'
            }
        };

        class GameUtils {
            static calculateGems(clickCount) {
                return Math.floor(clickCount / GAME_CONFIG.UI.GEMS_PER_CLICK);
            }

            static communicateWithParent(gems) {
                if (window.parent && window.parent !== window) {
                    try {
                        const currentGems = parseInt(localStorage.getItem(GAME_CONFIG.STORAGE.PARENT_GEMS_KEY) || '0');
                        const newGemCount = currentGems + gems;
                        localStorage.setItem(GAME_CONFIG.STORAGE.PARENT_GEMS_KEY, newGemCount.toString());

                        if (window.parent.updateGemDisplay) {
                            window.parent.updateGemDisplay(newGemCount);
                        }
                        return true;
                    } catch (error) {
                        console.warn('Could not update parent window:', error.message);
                        return false;
                    }
                }
                return false;
            }

            static saveGemsToStorage(gems) {
                localStorage.setItem(GAME_CONFIG.STORAGE.GEMS_KEY, gems.toString());
            }

            static getRandomPosition(maxWidth, maxHeight, elementWidth, elementHeight) {
                const x = Math.random() * (maxWidth - elementWidth);
                const y = Math.random() * (maxHeight - elementHeight);
                return { x, y };
            }

            static getRandomSize() {
                const baseSize = Math.random() * (GAME_CONFIG.PUMPKIN.MAX_SIZE - GAME_CONFIG.PUMPKIN.MIN_SIZE) + GAME_CONFIG.PUMPKIN.MIN_SIZE;
                return {
                    width: baseSize * 2,
                    height: baseSize * 4
                };
            }
        }

        class GameState {
            constructor() {
                this.clickCount = 0;
                this.pumpkins = new Set();
                this.isGameActive = true;
                this.gameTimer = null;
            }

            incrementScore() {
                this.clickCount++;
            }

            addPumpkin(pumpkin) {
                this.pumpkins.add(pumpkin);
            }

            removePumpkin(pumpkin) {
                this.pumpkins.delete(pumpkin);
            }

            getActivePumpkinCount() {
                return this.pumpkins.size;
            }

            endGame() {
                this.isGameActive = false;
                if (this.gameTimer) {
                    clearInterval(this.gameTimer);
                }
            }

            reset() {
                this.clickCount = 0;
                this.pumpkins.clear();
                this.isGameActive = true;
            }
        }

        class Pumpkin {
            constructor(gameState) {
                this.gameState = gameState;
                this.element = this.createElement();
                this.setupEventListeners();
                this.setupAutoRemove();
                this.gameState.addPumpkin(this.element);
            }

            createElement() {
                const pumpkin = document.createElement('img');
                pumpkin.src = GAME_CONFIG.PUMPKIN.IMAGE;
                pumpkin.alt = 'Pumpkin';
                pumpkin.className = 'pumpkin';

                const { width, height } = GameUtils.getRandomSize();
                const { x, y } = GameUtils.getRandomPosition(
                    window.innerWidth - 160,
                    window.innerHeight - 320,
                    width,
                    height
                );

                pumpkin.style.left = `${x}px`;
                pumpkin.style.top = `${y}px`;
                pumpkin.style.width = `${width}px`;
                pumpkin.style.height = `${height}px`;

                return pumpkin;
            }

            setupEventListeners() {
                this.element.addEventListener('click', () => {
                    this.onClick();
                });
            }

            onClick() {
                if (!this.gameState.isGameActive) return;

                this.gameState.incrementScore();
                this.updateCounter();
                this.fadeOut();
            }

            updateCounter() {
                const counterDisplay = document.getElementById('counter');
                if (counterDisplay) {
                    counterDisplay.textContent = `${GAME_CONFIG.UI.COUNTER_EMOJI} ${this.gameState.clickCount}`;
                }
            }

            fadeOut() {
                this.element.style.opacity = '0';
                setTimeout(() => {
                    this.destroy();
                }, GAME_CONFIG.PUMPKIN.FADE_DURATION);
            }

            setupAutoRemove() {
                setTimeout(() => {
                    if (document.body.contains(this.element)) {
                        this.fadeOut();
                    }
                }, GAME_CONFIG.PUMPKIN.LIFETIME);
            }

            destroy() {
                if (this.element.parentNode) {
                    this.element.parentNode.removeChild(this.element);
                }
                this.gameState.removePumpkin(this.element);
            }
        }

        class PumpkinGame {
            constructor() {
                this.state = new GameState();
                this.ui = this.initializeUI();
                this.pumpkinSpawner = null;
                this.gameEndTimer = null;
                this.init();
            }

            initializeUI() {
                return {
                    counter: document.getElementById('counter'),
                    backBtn: document.getElementById('back-btn'),
                    gameModal: document.getElementById('game-modal'),
                    finalScore: document.getElementById('final-score'),
                    gemsEarned: document.getElementById('gems-earned'),
                    closeModalBtn: document.getElementById('close-modal')
                };
            }

            init() {
                this.setupEventListeners();
                this.startGame();
            }

            setupEventListeners() {
                this.ui.backBtn?.addEventListener('click', () => {
                    this.exitGame();
                });

                this.ui.closeModalBtn?.addEventListener('click', () => {
                    this.exitGame();
                });

                this.ui.gameModal?.addEventListener('click', (e) => {
                    if (e.target === this.ui.gameModal) {
                        this.exitGame();
                    }
                });

                document.addEventListener('keydown', (e) => {
                    if (this.ui.gameModal.style.display === 'flex' && e.key === 'Escape') {
                        this.exitGame();
                    }
                });
            }

            startGame() {
                this.spawnInitialPumpkins();
                this.startPumpkinSpawner();
                this.scheduleGameEnd();
            }

            spawnInitialPumpkins() {
                for (let i = 0; i < GAME_CONFIG.PUMPKIN.INITIAL_COUNT; i++) {
                    setTimeout(() => {
                        this.spawnPumpkin();
                    }, i * GAME_CONFIG.PUMPKIN.SPAWN_DELAY);
                }
            }

            startPumpkinSpawner() {
                this.pumpkinSpawner = setInterval(() => {
                    if (this.state.getActivePumpkinCount() < GAME_CONFIG.PUMPKIN.MAX_COUNT && this.state.isGameActive) {
                        this.spawnPumpkin();
                    }
                }, GAME_CONFIG.PUMPKIN.SPAWN_INTERVAL);
            }

            spawnPumpkin() {
                const pumpkin = new Pumpkin(this.state);
                document.body.appendChild(pumpkin.element);
            }

            scheduleGameEnd() {
                this.gameEndTimer = setTimeout(() => {
                    this.endGame();
                }, GAME_CONFIG.UI.GAME_DURATION);
            }

            endGame() {
                this.state.endGame();
                this.showGameOverModal();
            }

            showGameOverModal() {
                const gems = GameUtils.calculateGems(this.state.clickCount);

                this.ui.finalScore.textContent = this.state.clickCount;
                this.ui.gemsEarned.textContent = gems;

                GameUtils.saveGemsToStorage(gems);
                GameUtils.communicateWithParent(gems);

                this.ui.gameModal.style.display = 'flex';
                this.ui.gameModal.setAttribute('aria-hidden', 'false');
                this.ui.closeModalBtn.focus();
            }

            exitGame() {
                const gems = GameUtils.calculateGems(this.state.clickCount);
                GameUtils.saveGemsToStorage(gems);
                GameUtils.communicateWithParent(gems);

                window.location.href = '/';
            }

            destroy() {
                if (this.pumpkinSpawner) {
                    clearInterval(this.pumpkinSpawner);
                }
                if (this.gameEndTimer) {
                    clearTimeout(this.gameEndTimer);
                }
                this.state.endGame();
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            try {
                const game = new PumpkinGame();

                window.addEventListener('beforeunload', () => {
                    game.destroy();
                });

            } catch (error) {
                console.error('Failed to initialize Pumpkin Game:', error);
            }
        });
    </script>
</body>
</html>